#!/bin/sh

VERSION=v2.0

VT=$(tty | sed 's/^.*tty/vt/g')

trysource() {
	test -f "$1" -a -r "$1" && source "$1"
}

printsessions() {
	local i=1
	OLDIFS="$IFS"
	eval IFS="$(printf "'\n'")"
	echo ''
	for sess in $SESSIONS
	do
		printf '\t%*u)  %s\n' ${#SESS_NUM} $i "${sess%%:*}"
		let i++
	done
	echo ''
	IFS="$OLDIFS"
}

if [ "$1" ]; then
	if [ "$1" = xlaunch ]; then
		command="$2"
		cd $HOME
		trysource ./.xprofile || trysource /etc/xprofile
		$command
		cd $HOME
		trysource ./.xlogout || trysource /etc/xlogout
		exit
	else
		trysource $1 || shift
	fi
fi
if [ ! "$1" ]; then
	trysource $HOME/.scdmrc || trysource /etc/scdmrc || \
		{ echo "ERROR: no config file!"; exit 1; }
fi

SESSIONS="$(printf '%s\n%s\n' "$SESSIONS" "Exit:C:true" | sed -e '/^\s*$/d' -e 's/^\s*//')"
SESS_NUM="$(echo "$SESSIONS" | wc -l)"

LINE=--------------------------------------------------------------------------------
printf "\n%s %s\n%s\nSelect a session:\n" "$(basename $0)" "$VERSION" "$LINE"

printsessions

i=0
while true
do
	if [ $i -ge 7 ]
	then
		printsessions
		i=0
	else
		let i++
	fi
	printf '%s ' "${PS3:=>}"
	read n
	if [ -n "$n" -a $n -ge 1 -a $n -le $SESS_NUM ] 2> /dev/null
	then
		break
	else
		printf "You must specify a number between 1 and %s!\n" "$SESS_NUM" >&2
	fi
done

SESSION="$(echo "$SESSIONS" | sed -n "${n}p")"

TYPE=${SESSION#*:}
TYPE=${TYPE%:*}
CMD=${SESSION##*:}

export SCDM_SPAWN=$$
clear
printf 'Starting %s...\n' "${SESSION%%:*}"
if [ "${TYPE/X/x}" = x ]
then
	cd $(dirname $0)
	exec startx $PWD/$(basename $0) xlaunch "$CMD" -- "$XSERVER_ARGS" $VT > /dev/null 2>&1
else
	cd $HOME
	exec $CMD
fi
