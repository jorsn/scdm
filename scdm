#!/bin/sh

SELF="$(basename "$0")"

VERSION=v2.0

VT="$(tty | sed 's/^.*tty\([0-9]\+\)$/vt\1/g')"

fail() {
	fmt="$1"
	shift
	printf "\n%s$fmt\n\n" "$SELF: ERROR: " "$@" >&2
	exec "$(sed -n "s/^$USER:.\+://gp" /etc/passwd)"
}

trysource() {
#shellcheck source=./scdmrc
	test -f "$1" -a -r "$1" && . "$1"
}

printsessions() {
	echo "$PRINTSESSIONS"
}

if [ -n "$1" ]; then
	if [ "$1" = xlaunch ]; then
		command="$2"
#shellcheck disable=SC2164
# disable warning about cd failure
		cd "$HOME"
		trysource "$HOME/.xprofile" || trysource /etc/xprofile
		$command
#shellcheck disable=SC2164
		cd "$HOME"
		trysource "$HOME/.xlogout" || trysource /etc/xlogout
		exit
	else
		#TODO
		trysource "$1" || shift
	fi
fi
if [ -z "$1" ]; then
	trysource "$HOME/.scdmrc" || trysource /etc/scdmrc || \
		fail "no config file!"
fi

SESSIONS="$(printf '%s\n%s\n' "$SESSIONS" "Exit:C:true" | sed -e '/^\s*$/d' -e 's/^\s*//')"
SESS_NUM="$(echo "$SESSIONS" | wc -l)"
PRINTSESSIONS="$(echo ''; \
	echo "$SESSIONS" | awk -F : "{printf \"%${SESS_NUM}i)  %-s\n\",NR,\$1}"; \
	echo ' ')"

LINE=--------------------------------------------------------------------------------
printf "\n%s %s\n%s\nSelect a session:\n" "$SELF" "$VERSION" "$LINE"

printsessions

i=0
while true
do
	if [ $i -ge 7 ]
	then
		printsessions
		i=0
	else
		i=$((i+1))
	fi
	printf '%s ' "${PS3:=>}"
	read -r n
	if [ -n "$n" ] && [ 1 -le "$n" ] && [ "$n" -le "$SESS_NUM" ]
	then
		break
	else
		printf "You must specify a number between 1 and %s!\n" "$SESS_NUM" >&2
	fi
done

SESSION="$(echo "$SESSIONS" | sed -n "${n}p")"

TYPE="${SESSION#*:}"
TYPE="${TYPE%:*}"
CMD="${SESSION##*:}"

export SCDM_SPAWN=$$
clear
printf 'Starting %s...\n' "${SESSION%%:*}"
if [ "$TYPE" = X ] || [ "$TYPE" = x ]
then
	dirname="$(dirname "$0")"
	cd "$dirname" || fail 'could not cd to: %s' "$dirname"
	exec startx "$PWD/$SELF" xlaunch "$CMD" -- "$XSERVER_ARGS" "$VT" > /dev/null 2>&1
else
	cd "$HOME" || fail 'could not cd to: %s' "$HOME"
#shellcheck disable=SC2086
# do not complain about missing quotes
	exec $CMD
fi
